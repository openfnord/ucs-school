stages:
  - prepare
  - lint
  - build

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "webide"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_OPEN_MERGE_REQUESTS
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_PROTECTED == "true"

include:
  - project: univention/dist/docker-services
    file: kaniko.yml

variables:
  pipeline:
    value: ""
    description: "Skip or force jobs: '(skip|force)-(doc)'. With 'force-doc-$doc-basename the jobs run for a distinct document."

generate-config:
  stage: prepare
  image:
    name: docker-registry.knut.univention.de/knut/deb-builder
    entrypoint: [""]
  script:
    - .gitlab-ci/build-ci
  artifacts:
    paths:
      - generated-config-doc.yml

doc-pipeline:
  stage: build
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /skip-doc/ || $pipeline =~ /skip-doc/"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /force-doc/ || $pipeline =~ /force-doc/"
    - changes:
      - "doc/ucsschool-import/**/*"
      - "doc/ucsschool-manual/**/*"
      - "doc/ucsschool-quickstart/**/*"
      - "doc/ucsschool-scenarios/**/*"
      - "doc/ucsschool-umc-user-import/**/*"
      - "doc/ucsschool-changelog/**/*"
  needs:
    - job: generate-config
  trigger:
    include:
      - artifact: generated-config-doc.yml
        job: generate-config
    strategy: depend
    forward:
      pipeline_variables: true

build pre-commit:
  stage: prepare
  rules:
    - changes:
      - .gitlab-ci/Dockerfile.pre-commit
      - .bandit
      - .black
      - .dockerignore
      - .flake8
      - .isort.cfg
      - .pre-commit-config.yaml
  extends: .kaniko
  variables:
    DOCKERFILE_PATH: .gitlab-ci/Dockerfile.pre-commit
    KANIKO_ARGS: --cache=true

run pre-commit:
  stage: lint
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE
  needs:
    - job: build pre-commit
      optional: true
  image:
    name: $IMAGE_TAG
  script:
    - pre-commit run -a
