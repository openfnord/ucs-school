stages:
  - prepare
  - lint

include:
  - project: univention/dist/docker-services
    file: kaniko.yml
  - template: 'Workflows/Branch-Pipelines.gitlab-ci.yml'

build-image:
  stage: prepare
  rules:
    - if: '$CI_COMMIT_BRANCH !~ /[1-9][0-9]*[.][0-9]+/'
      when: never
    - changes:
      - .gitlab-ci/Dockerfile.pre-commit
      - .bandit
      - .black
      - .dockerignore
      - .flake8
      - .isort.cfg
      - .pre-commit-config.yaml
  extends: .kaniko_knut
  variables:
    IMAGE_TAG: $CI_REGISTRY/ucsschool/pre-commit:$CI_COMMIT_REF_SLUG
    DOCKERFILE_PATH: .gitlab-ci/Dockerfile.pre-commit

run pre-commit:
  stage: lint
  image:
    name: docker-registry.knut.univention.de/ucsschool/pre-commit:5-0
    entrypoint: [""]
  script:
    - pre-commit run -a
