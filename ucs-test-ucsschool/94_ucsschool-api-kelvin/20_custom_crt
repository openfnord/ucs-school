#!/usr/share/ucs-test/runner bash
## desc: test if using a different certificate works
## tags: [ucs_school_kelvin]
## exposure: dangerous
## bugs: [51510]

#"$TESTLIBPATH/undo.sh" || exit 137

host="$(ucr get hostname).$(ucr get domainname)"

python generate_certificate.py
ucr set apache2/ssl/key="$(pwd)/$host.key"
ucr set apache2/ssl/ca="$(pwd)/myCA.pem"
ucr set apache2/ssl/certificate="$(pwd)/$host.crt"
service apache2 restart
univention-app configure ucsschool-kelvin-rest-api --set ucsschool/kelvin/trusted_CA_path="$(pwd)/myCA.pem"

# clean up afterwards
#undo ucr unset apache2/ssl/key apache2/ssl/ca apache2/ssl/certificate
#undo service apache2 restart
#undo univention-app configure --unset ucsschool/kelvin/trusted_CA_path
#undo rm myCA*
#undo rm "$host*"


token=$(curl  -k -X POST http://$host/ucsschool/kelvin/token\
  -H "Content-Type:application/x-www-form-urlencoded"\
  -d "username=Administrator"\
  -d "password=univention" | jq .access_token | tr -d '"')

# test curl:
curl -X GET "http://$host/ucsschool/kelvin/v1/schools/demoschool"\
  -H "accept: application/json"\
  -H "Authorization: Bearer $token"\


