#!/usr/share/ucs-test/runner bash
## desc: run tests in container which are supplied by the kelvin api
## tags: [ucs_school_kelvin]
## exposure: dangerous
## packages: []
## bugs: []

APP="ucsschool-kelvin-rest-api"
MIN_COVERAGE=70

declare -a CMD=(sh -c "
cd /kelvin/kelvin-api &&
export MY_COVERAGE_REPORT_ARGS=\"--fail-under=$MIN_COVERAGE\" &&
rm -f .coverage &&
make coverage")

echo "Running in container:" "${CMD[@]}"

function cleanup_mail_domain {
	udm mail/domain remove --ignore_not_exists --dn cn=example.org,cn=domain,cn=mail,"$(ucr get ldap/base)"
	udm mail/domain remove --ignore_not_exists --dn cn="$(ucr get domainname)",cn=domain,cn=mail,"$(ucr get ldap/base)"
}
trap cleanup_mail_domain EXIT
udm mail/domain create --ignore_exists --position cn=domain,cn=mail,"$(ucr get ldap/base)" --set name=example.org
udm mail/domain create --ignore_exists --position cn=domain,cn=mail,"$(ucr get ldap/base)" --set name="$(ucr get domainname)"
univention-app shell "$APP" "${CMD[@]}" || (rv=$?; pkill -f '^/usr/bin/python.*pytest$'; exit $rv)
